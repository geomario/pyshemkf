# Read routine for uindex arrays
import os
import numpy as np

from mypackage.tools.plot import specs as sc

from mypackage.tools.run import pythonmodule as pm
from mypackage.scripts.uindex import arrays as ua
from mypackage.scripts.forward import arrays as fa
from mypackage.scripts.forward import read as fr


def read(
        model_name,
        dat,
        let,
        fdir=None,
        fname=None,
        varname='uindex',
        nt=0,
        uindex=1,
):
    """
    Reading variable array for single unit from SHEMAT-Suite
    vtk-file.

    Parameters
    ----------
    model_name : string
        String of model name.

    dat : string
        String with date of model run.

    let : string
        String of letter of model run.

    varname : string
        Variable name for array to be read.
        Possibilities: 'uindex' 'head','temp','kz', 'v'

    nt : string
        Number of time step output.

    uindex : integer
        Unit Index for the unit at which to extract the values of
        the variabel specifiec in varname.

    Returns
    -------
    uindex_var_array : array
        Array containing the variable array at certain uindex
        value.

    uindex_var_array_name : string
        Containing proposed saving location for Array.
    """

    # forward-array and uindex-array names
    forward_array_name = pm.py_output_filename(
        fa.tag,
        varname,
        sc.specl(model_name, dat, let)+'_'+str(nt),
        "npy"
    )
    uindex_array_name = pm.py_output_filename(
        fa.tag,
        'uindex',
        sc.specl(model_name, dat, let)+'_'+str(nt),
        "npy"
    )

    # Generate forward-array and uindex-array if needed
    if not os.path.isfile(forward_array_name):
        numpy_array, numpy_array_name = fr.read(
            model_name=model_name,
            dat=dat,
            let=let,
            fdir=fdir,
            fname=fname,
            varname=varname,
            nt=nt,
        )
        np.save(numpy_array_name, numpy_array)

    if not os.path.isfile(uindex_array_name):
            model_name=model_name,
            dat=dat,
            let=let,
        numpy_array, numpy_array_name = fr.read(
            fdir=fdir,
            fname=fname,
            varname='uindex',
            nt=nt,
        )
        np.save(numpy_array_name, numpy_array)

    # Load forward-array and uindex-array
    forward_array = np.load(forward_array_name)
    uindex_array = np.load(uindex_array_name)

    # Uindex Array
    uindex_var_array = forward_array[uindex_array == uindex]

    # Uindex Array Name
    uindex_var_array_name = pm.py_output_filename(
        ua.tag,
        varname,
        sc.specl(model_name, dat, let)+'_'+str(nt)+'_'+str(uindex),
        "npy",
    )

    return uindex_var_array, uindex_var_array_name
