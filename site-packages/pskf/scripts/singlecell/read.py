# Read routine for singlecell arrays
import numpy as np

from pskf.tools.plot import specs as sc

from pskf.tools.plot import plotfunctions as pf
from pskf.tools.run import runmodule as rm
from pskf.tools.run import pythonmodule as pm
from pskf.scripts.singlecell import arrays as sca


def read(
        model_name,
        dat,
        let,
        fdir=None,
):
    """
    Reading variable array from SHEMAT-Suite vtk-file.

    Parameters
    ----------
    model_name : string
        String of model name.

    dat : string
        String with date of model run.

    let : string
        String of letter of model run.

    Returns
    -------
    numpy_array : array
        Array containing the full single_cell array
        numpy_array[irobs,iens,iloc]:
        - irobs: Observation time index
        - iens: Ensemble member index
        - iloc: Single cell location index

    numpy_array_name : string
        Containing proposed saving location for Array.
    """

    # Single cell output directory
    if fdir is None:
        # single_cell_output_dir
        fdir = (rm.make_output_dirs(model_name, dat, let)[0]
                + '/single_cell_output')

    # Read single cell location and variable
    locs = sc.single_cell_locs(model_name, dat, let)
    variables = sc.single_cell_variables(model_name, dat, let)

    # Generate empty numpy_array
    nrobs_int = sc.nrobs_int(model_name, dat, let)
    num_locs = sc.num_single_cell(model_name, dat, let)
    nrens = sc.nrens(model_name, dat, let)
    numpy_array = np.zeros([nrobs_int, nrens, num_locs])

    # single_cell_output_file
    for iloc, loc in enumerate(locs):
        fname = ('single_cell_E1_'
                 + str(loc[0]).zfill(4)+'_'
                 + str(loc[1]).zfill(4)+'_'
                 + str(loc[2]).zfill(4)+'_'
                 + str(variables[iloc]).zfill(4)+'_aft'+'.txt')

        numpy_array[:, :, iloc] = np.loadtxt(fdir+'/'+fname,
                                             skiprows=5)

    # Numpy Array Name ########################################################
    numpy_array_name = pm.py_output_filename(
        sca.tag,
        'single_cell',
        sc.specl(model_name, dat, let)+'_'+str(num_locs),
        "npy",
    )

    return numpy_array, numpy_array_name
