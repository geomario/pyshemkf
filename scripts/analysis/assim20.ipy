# Assimilation step in Python for debugging purposes

import os
import matplotlib as mpl
import numpy as np
import exceptions
from mypackage.plot import plotfunctions as pf
from mypackage.plot import plotarrays as pa
from mypackage.run import runmodule as rm
from matplotlib import cm		# Colormap commands (cm.get_cmap())
from mypackage.plot import mycolors
import pandas as pd

# Var mit 20, cov mit 19


N = 20
M = 1
n = 2

a=np.array([-0.105063E+02,-0.105693E+02,-0.106363E+02,-0.107109E+02,
-0.107805E+02,-0.108647E+02,-0.109494E+02,-0.110639E+02,-0.112275E+02,
-0.114220E+02,-0.958216E+01,-0.981844E+01,-0.100853E+02,-0.997193E+01,
-0.101315E+02,-0.102652E+02,-0.103624E+02,-0.106175E+02,-0.103708E+02,
-0.104871E+02,-0.104534E+02,-0.105746E+02,-0.106881E+02,-0.108414E+02,
-0.106834E+02,-0.108278E+02,-0.109622E+02,-0.111359E+02,-0.110411E+02,
-0.114920E+02,-0.956210E+01,-0.987687E+01,-0.996246E+01,-0.100589E+02,
-0.101654E+02,-0.102412E+02,-0.103143E+02,-0.103731E+02,-0.104429E+02,
-0.105086E+02]).reshape(n,N)

rot=np.array([-0.213796E+00,0.395975E+00,-0.288228E-01,0.925024E-01,
0.279941E+00,0.172878E+00,0.373593E+00,0.943901E-01,0.761189E-01,
-0.130451E+00,0.196364E-01,-0.488116E-01,0.207808E-01,-0.198169E+00,
0.848835E-01,0.333261E+00,-0.543952E-02,-0.537187E+00,0.242217E+00,
-0.234999E-01,-0.130767E+00,0.271293E+00,0.332232E+00,0.990415E-01,
-0.231719E-01,-0.604478E-02,-0.215977E+00,-0.445598E+00,-0.422673E-02,
-0.356482E+00,0.141284E+00,0.293671E-01,-0.194719E-01,0.408535E+00,
0.691260E-01,0.251516E+00,0.352649E+00,0.156864E+00,0.104468E+00,
-0.146346E-01,0.244098E+00,-0.616748E-01,-0.124479E+00,0.268011E+00,
0.219743E+00,0.286664E+00,-0.321379E+00,0.501784E+00,-0.700649E-01,
-0.609233E-01,0.162712E+00,-0.345943E+00,-0.173952E+00,0.302678E+00,
0.755972E-01,0.121617E+00,0.166212E+00,-0.864681E-01,-0.166278E+00,
0.620454E-01,0.881934E-01,0.870013E-01,-0.213670E+00,-0.385960E+00,
0.145119E+00,0.278553E+00,-0.188661E+00,0.262297E-01,0.177409E+00,
0.183219E-01,0.183324E+00,0.224216E+00,0.131608E+00,-0.161166E+00,
-0.476438E+00,0.199219E+00,0.185631E+00,0.169162E+00,0.123038E+00,
0.388870E+00,0.990463E-01,0.107420E+00,-0.510781E-01,-0.220819E+00,
-0.547686E+00,0.377127E+00,0.149506E+00,0.586876E-01,0.771021E-01,
0.168707E+00,-0.165776E+00,-0.344906E+00,0.305126E+00,0.115763E+00,
0.298712E+00,0.109969E+00,0.948776E-01,0.127344E+00,0.210984E+00,
0.298952E-01,0.110380E+00,0.893230E-01,0.410860E+00,-0.386248E-01,
-0.150862E+00,-0.235009E+00,-0.440936E-01,0.365851E+00,-0.383558E+00,
0.228930E+00,-0.928728E-01,0.313150E+00,0.328996E+00,0.156204E+00,
-0.152849E+00,0.105835E+00,0.179516E+00,-0.282775E+00,-0.880052E-02,
0.100400E+00,0.147620E-01,0.305265E+00,0.245319E+00,-0.213265E+00,
0.201468E+00,0.170388E-02,-0.120166E-01,-0.528043E-01,0.114798E+00,
0.454529E+00,-0.118247E+00,0.219025E-03,-0.443299E+00,-0.578110E-01,
0.334855E+00,-0.205038E+00,0.214592E+00,0.147566E-01,-0.127175E+00,
0.327390E+00,-0.118144E-01,-0.254539E+00,0.607336E-01,0.141333E+00,
0.253896E+00,-0.313920E-01,0.316341E+00,0.175768E+00,-0.258437E+00,
-0.190200E+00,-0.394595E+00,0.157507E-01,-0.537015E-01,-0.179198E+00,
0.950073E-01,0.175794E+00,0.279088E+00,0.479192E+00,0.213531E+00,
0.167442E+00,-0.202850E-01,-0.336978E+00,-0.772418E-02,-0.657678E-01,
0.309018E+00,0.291584E+00,-0.509978E-01,-0.103647E+00,-0.910484E-01,
0.766092E-01,0.154299E+00,0.256015E+00,0.199960E+00,0.206270E+00,
0.277651E+00,-0.414573E+00,0.840074E-01,-0.170960E+00,0.461988E+00,
-0.554205E-01,-0.338013E+00,0.293933E-01,0.152035E+00,0.324885E+00,
-0.750943E-01,-0.271994E-01,0.795839E-02,0.286072E+00,0.526900E+00,
0.102178E+00,-0.195368E+00,0.255076E-01,-0.481775E-01,0.294928E+00,
-0.293337E+00,-0.191420E+00,-0.114650E+00,0.104962E+00,0.295220E+00,
0.133221E+00,0.330410E+00,-0.168986E+00,0.146585E+00,-0.140604E+00,
0.169878E+00,0.170140E+00,0.356214E+00,-0.360722E-01,0.388284E+00,
0.780207E-01,-0.157989E+00,0.198017E+00,-0.247214E-01,0.242522E+00,
-0.133356E+00,0.151360E+00,0.181282E+00,-0.194881E-01,-0.284849E+00,
-0.446648E+00,0.390024E+00,-0.767432E-01,0.322005E+00,0.199453E+00,
-0.536969E-04,-0.218180E+00,0.144788E+00,-0.435883E-01,0.282290E+00,
-0.842535E-01,0.359710E+00,-0.324140E+00,0.224529E+00,-0.338325E+00,
-0.509179E-01,-0.224299E+00,0.242108E+00,-0.424485E-01,0.107129E+00,
0.130911E+00,0.457015E+00,0.252737E+00,0.634538E-01,0.953760E-01,
-0.226183E+00,0.179191E+00,0.149181E+00,0.140112E+00,-0.908974E-02,
-0.384093E+00,0.677030E-01,0.435693E+00,-0.240334E+00,0.273971E-01,
0.141076E+00,-0.152954E+00,-0.323703E+00,0.812577E-01,0.814371E-01,
0.164727E+00,0.393492E-01,-0.155024E+00,-0.453504E+00,0.398778E+00,
-0.165629E+00,-0.154043E+00,0.201601E+00,-0.216080E+00,0.121318E+00,
0.180778E+00,0.636102E-01,0.265586E+00,0.791273E-01,0.165572E+00,
0.173786E+00,0.157997E+00,0.223059E+00,-0.149736E+00,-0.173992E+00,
0.397446E+00,0.178880E+00,0.184366E+00,-0.284306E-02,0.482330E+00,
-0.356241E-01,0.210886E+00,-0.173512E+00,-0.151124E+00,-0.132974E+00,
0.484433E+00,0.503263E-01,0.138971E+00,-0.813391E-01,-0.269073E+00,
-0.118046E+00,0.147408E+00,0.755467E-02,0.192755E+00,0.234991E+00,
-0.348365E+00,0.620076E-01,0.115748E+00,0.174350E+00,0.185304E+00,
0.350363E+00,0.165913E+00,-0.169333E+00,-0.142347E+00,0.108353E+00,
0.129979E-01,-0.245381E+00,-0.131043E-02,0.547434E+00,-0.280981E-01,
0.178258E+00,0.539318E-01,-0.393994E+00,0.127741E+00,-0.310564E+00,
0.208626E+00,0.303276E-01,-0.349772E+00,0.241213E+00,-0.143211E+00,
0.258903E-01,-0.176382E+00,-0.231330E-01,0.490283E-01,0.136605E+00,
0.194873E+00,0.318669E+00,0.136189E-01,-0.149730E+00,0.619091E-01,
0.229663E+00,0.550706E+00,-0.400101E+00,0.712017E-01,0.217490E+00,
0.101132E+00,-0.209796E+00,0.979171E-01,0.987760E-01,0.489182E-01,
0.741020E-01,0.202911E+00,0.517144E+00,-0.123498E-01,-0.312139E+00,
0.182555E+00,0.466339E+00,-0.116098E+00,0.422574E-01,0.233040E+00,
-0.205943E+00,-0.124729E+00,-0.137509E+00,0.267135E+00,-0.210573E+00,
0.980419E-01,-0.354233E+00,0.670981E-01,0.328289E-02,0.525650E-02,
-0.845187E-01,0.100304E-01,-0.795922E-01,0.382195E+00,0.216327E+00,
-0.660049E-01,0.321409E+00,0.320407E+00,0.173164E+00,-0.256568E+00,
0.369471E+00,-0.944103E-02,0.213320E+00,0.246737E+00,-0.237289E+00,
-0.241052E+00,0.234211E+00,0.400181E+00,-0.368725E+00,-0.132937E+00,
0.279405E+00,-0.499332E+00,0.623684E-01,0.123492E+00,0.360322E-01,
0.894748E-01,0.612062E-01,-0.553094E-01,0.181743E+00,0.273592E+00,
0.102801E+00,-0.361586E-01,-0.485004E-01,0.249955E+00,0.227027E+00,
-0.180528E+00]).reshape(N,N).transpose()


s =np.array([0.193936E-01,-0.500169E-01,-0.117411E+00,-0.187902E+00,
-0.260396E+00,-0.340257E+00,-0.431870E+00,-0.547319E+00,-0.704439E+00,
-0.906583E+00,0.946576E+00,0.699699E+00,0.439032E+00,0.545376E+00,
0.390752E+00,0.267600E+00,0.148670E+00,-0.913778E-01,0.148049E+00,
0.324251E-01]).reshape([M,N])

d=np.array([0.127808E+01,0.136368E+01,0.147295E+01,0.980553E+00,
0.125559E+01,0.141288E+01,0.111501E+01,0.159702E+01,0.129237E+01,
0.129226E+01,-0.529870E+00,-0.171076E-01,-0.215654E+00,-0.220265E+00,
-0.416268E+00,-0.177729E+00,0.148511E+01,0.560448E+00,0.378985E+00,
0.994443E+00]).reshape([M,N])

eig =  np.array([0.125106E+00])
w = np.array([0.100000E+01])
innov =  0.745124E+00


# Normal EnKF
# ===============

# x3 from eig and d
x3 = eig*d
# reps from a*sT
reps = np.dot(a,s.transpose())

# Damping factor
assidamp = 1.0

# Final update
afin_enkf = a + assidamp*np.dot(reps,x3)


# Sqrt EnKF
# ===============

# meanx5
y1 = np.dot(w.transpose(),innov)
y2 = np.dot(eig,y1)
y3 = np.dot(w,y2)
y4 = np.dot(s.transpose(),y3)

x51 = np.array([y4 for i in range(N)]).transpose()
x5 = (1.0/float(N))*np.ones([N,N]) + x51

# genx2
x21 = np.dot(w.transpose(),s).reshape(M,N)
x2 = np.array([[np.sqrt(eig)[i]*x21[i,j] for j in range(N)] for i in range(M)])

# x5sqrt
u,sig,vt = np.linalg.svd(x2)
vt = -vt                                  #Different svd method 
isigma = np.array([(np.sqrt(np.max(1.0-sig[i]*sig[i])) if i<M else 1) for i in range(N)])
x31 = vt.transpose()
x3 = np.array([[x31[i,j]*isigma[j] for j in range(N)] for i in range(N)])
x33 = np.dot(x3,vt)
x4 = np.dot(x33,rot)
x4 = x33
x5_sqrt = x5+ np.dot(np.identity(N)-(1.0/N)*np.ones([N,N]),x4)

afin_sqrt = np.dot(a,x5_sqrt)

